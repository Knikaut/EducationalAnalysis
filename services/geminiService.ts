import { GoogleGenAI } from "@google/genai";

// Initialize Gemini Client
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

/**
 * Performs the specific analysis requested in the prompt using the JSON data.
 */
export const analyzeUniversityData = async (jsonString: string): Promise<string> => {
  const modelId = 'gemini-2.5-flash';

  const systemInstruction = `
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã (Senior Admissions Consultant).
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å –û–ë–™–ï–ö–¢–ò–í–ù–´–ô, –ì–õ–£–ë–û–ö–ò–ô –∏ –ü–û–õ–ï–ó–ù–´–ô –æ—Ç—á–µ—Ç –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.

    –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
    1. JSON-–¥–∞–Ω–Ω—ã–µ –∏–∑ Instagram (–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∂–∏–∑–Ω—å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å).
    2. –¢–≤–æ—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Search (–¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –Ω–∞ —Å–∞–π—Ç–µ –í–£–ó–∞).

    –¢–í–û–ô –ü–û–î–•–û–î:
    ‚Äî –ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–µ–Ω. –ï—Å–ª–∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ø—Ä–µ—Å—Ç–∏–∂–Ω—ã–π (–∫–∞–∫ Harvard, Princeton, MIT, Oxford –∏ —Ç.–¥.), –ø—Ä–∏–∑–Ω–∞–≤–∞–π –∏—Ö —Å—Ç–∞—Ç—É—Å. –ù–µ –Ω–∞–∑—ã–≤–∞–π –∏—Ö "—Å–∫—É—á–Ω—ã–º–∏" –∏–ª–∏ "—Å–∫–∞–º–æ–º" –∏–∑-–∑–∞ –Ω–∏–∑–∫–∏—Ö –ª–∞–π–∫–æ–≤. –≠—Ç–æ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è, –∞ –Ω–µ –±–ª–æ–≥–µ—Ä—ã.
    ‚Äî –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–Ω—Ç: –æ —á–µ–º –æ–Ω–∏ –ø–∏—à—É—Ç? –ù–∞—É–∫–∞, —Å–ø–æ—Ä—Ç, –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —É—Å–ø–µ—Ö–∏ –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤?
    ‚Äî –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã: "Instagram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Å–µ–ª—É—é –∂–∏–∑–Ω—å, –Ω–æ —Å–∞–π—Ç –≥–æ–≤–æ—Ä–∏—Ç –æ –∂–µ—Å—Ç–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö".
    ‚Äî –ë—É–¥—å –ø–æ–ª–µ–∑–µ–Ω –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç—É: –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã.
  `;

  const analysisPrompt = `
    –í–æ—Ç JSON-—Ñ–∞–π–ª —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏ Instagram-–∞–∫–∫–∞—É–Ω—Ç–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:
    \`\`\`json
    ${jsonString}
    \`\`\`

    –ó–ê–î–ê–ß–ê:
    1. –ò—Å–ø–æ–ª—å–∑—É–π **Google Search**, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç —ç—Ç–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.
    2. –ù–∞–π–¥–∏ –Ω–∞ —Å–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é (Admission Requirements), —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –∏ —Å—Ä–æ–∫–∏ –ø–æ–¥–∞—á–∏.
    3. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π JSON –∏–∑ Instagram, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å "–≤–∞–π–±" –∏ –∫—É–ª—å—Ç—É—Ä—É.

    –°–æ—Å—Ç–∞–≤—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–∞ –†—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –ø–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

    –ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞

    üéì –û–ë–©–ê–Ø –†–ï–ü–£–¢–ê–¶–ò–Ø
    ‚Äî –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (Ivy League, Public Research, Art School –∏ —Ç.–¥.).
    ‚Äî –†–µ–π—Ç–∏–Ω–≥ –∏ –ø—Ä–µ—Å—Ç–∏–∂ (–∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–∏—Å–∫–∞).

    üèõ –ê–ù–ê–õ–ò–ó –û–§–ò–¶–ò–ê–õ–¨–ù–û–ì–û –°–ê–ô–¢–ê (–§–ê–ö–¢–´)
    ‚Äî –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é: GPA, —ç–∫–∑–∞–º–µ–Ω—ã (SAT/ACT, IELTS/TOEFL), –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ.
    ‚Äî –î–µ–¥–ª–∞–π–Ω—ã –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
    ‚Äî –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ).
    ‚Äî –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è/—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—ã.

    üì∏ –ê–ù–ê–õ–ò–ó INSTAGRAM (–ê–¢–ú–û–°–§–ï–†–ê)
    ‚Äî –ù–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–∞ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∂–∏–∑–Ω—å?
    ‚Äî –°—Ç–∏–ª—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (–æ—Ñ–∏—Ü–∏–æ–∑ –∏–ª–∏ –¥—Ä—É–∂–µ–ª—é–±–∏–µ).
    ‚Äî –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö.

    ‚öñÔ∏è –°–ò–õ–¨–ù–´–ï –ò –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´
    ‚úÖ –ü–ª—é—Å—ã: (–ö–∞—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –∫–∞–º–ø—É—Å, –∫–∞—Ä—å–µ—Ä–∞, —Å–æ–æ–±—â–µ—Å—Ç–≤–æ).
    ‚ùå –ú–∏–Ω—É—Å—ã: (–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Å—Ç–æ–∏–º–æ—Å—Ç—å, –ª–æ–∫–∞—Ü–∏—è, –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏, –∑–∞–º–µ—á–µ–Ω–Ω—ã–µ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö).

    üí° –í–ï–†–î–ò–ö–¢ –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê
    ‚Äî –ö–æ–º—É —ç—Ç–æ—Ç –í–£–ó –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç?
    ‚Äî –°—Ç–æ–∏—Ç –ª–∏ –ø–æ–¥–∞–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã?

    –§–æ—Ä–º–∞—Ç: –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω. –ë–µ–∑ Markdown —Ä–∞–∑–º–µ—Ç–∫–∏ (**bold** –Ω–µ –Ω—É–∂–µ–Ω), –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏.
  `;

  const response = await ai.models.generateContent({
    model: modelId,
    contents: analysisPrompt,
    config: {
      systemInstruction: systemInstruction,
      // Enable Google Search to find website data
      tools: [{ googleSearch: {} }],
    }
  });

  if (!response.text) {
    throw new Error("Failed to analyze the data.");
  }

  return response.text;
};
